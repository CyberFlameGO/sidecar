
language: go

go:
  - 1.7.x
  - master

sudo: required

services:
  - docker

before_install:
  - sudo apt-get install -y nodejs npm

script:
  - go test -v ./... && (CGO_ENABLED=0 GOOS=linux go build -ldflags '-d')
  - if [ "$TRAVIS_BRANCH" == "master" ] && [ "${TRAVIS_GO_VERSION::3}" == "${PRODUCTION_GO_VERSION}" ]; then
      echo "Building container gonitro/sidecar:${TRAVIS_COMMIT::7}" &&
      cd ui && npm install && cd .. &&
      cp docker/sidecar.docker.toml docker/sidecar.toml &&
      docker build -f docker/Dockerfile -t sidecar .  &&
      docker tag sidecar gonitro/sidecar:${TRAVIS_COMMIT::7} &&
      docker tag sidecar gonitro/sidecar:latest;
    fi

after_success:
  - docker login -u="$DOCKER_USERNAME" -p="$DOCKER_PASSWORD"
  - echo "Building on Go version ${TRAVIS_GO_VERSION} for branch ${TRAVIS_BRANCH}"
  - if [ "$TRAVIS_BRANCH" == "master" ] && [ "${TRAVIS_GO_VERSION::3}" == "${PRODUCTION_GO_VERSION}" ]; then
      echo "Pushing container gonitro/sidecar:${TRAVIS_COMMIT::7}" &&
      docker push gonitro/sidecar:${TRAVIS_COMMIT::7};
    fi
  - if [ "$TRAVIS_BRANCH" == "master" ] && [ "${TRAVIS_GO_VERSION::3}" == "${PRODUCTION_GO_VERSION}" ] && [ -z "${NO_PUSH_LATEST}" ]; then
      docker push gonitro/sidecar:latest;
    fi

deploy:
  provider: releases

  api_key:
    secure: j3UGakWMqMPhqcpdHgwAFeAL2ZrWHgPYoKhGnZFVcbwWCLQb+OtAAVlLVZAMccY38G29U8S1ExOpXxr6n7gG7LM9pEfIASYOfLM1FqYzuFZTn/qPqkw2ENs3zkQlusHXIGFPSQtRcBLPX6OVMMPYtwfIfqdXW1wqLoEeifAIfFaa9ugd4xZ47ib9w5zAB1lOYIn+E7uk5p+8v4AbLfaaxkaHx7bKH2Pe40nyehsU4kwLkq5387mDb+WA2rO1e9E27CZd/7onlMyQzdfxFyzdfOOV2+CiVUOdWK2ISZfAajyfL4/a+SiBkaF92KuTF5PTWdHBTsXxxsLsCa8AXvspfSlsPk1WJvvvfCTMxgM56+xE/R5Ztfj/02g7r2/izKcpguH/smtSm9psDIRsjA/SyKBbxw9nNruIq0DOzcAQQO1kKGzwuonty7IYfPNS/LfZWA6v+xU54czMXfG7iSJGlmmLrCGjmRVmrY99by4d2Ml0dMKqQfLw2OiSBKpLooLKz5Hd9rX0SnrQmp+glmg+cRi1amJ9sPvo+3Ih0gGBnj9YmLowvYVY81TzdTxY6VVbmUsF3F2BFufEMLUsUL9VoyixDbNXFSrJB9ENI960v7gbCUmTRpK/X9GYnSoAKflwc/WrT/AAvlSnwi6SSX8gNpwOB7UUApRiYjjPwZdDFpY=

  file: sidecar

  skip_cleanup: true

  on:
    tags: true
    condition: ${TRAVIS_GO_VERSION::3} == ${PRODUCTION_GO_VERSION}
